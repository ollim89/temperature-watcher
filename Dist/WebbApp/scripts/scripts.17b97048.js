"use strict";angular.module("temperatureWatcherwebAppApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/auth",{templateUrl:"views/auth.html",controller:"AuthCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("temperatureWatcherwebAppApp").controller("MainCtrl",["$scope","$http","AppSettings","$interval","AuthService","$location","$q",function(a,b,c,d,e,f,g){function h(){b.get(c.apiUrl+"/AuthUsed/").success(function(a){1==a&&(o=!0,$("#auth-button-container").show(),e.getUser().then(function(){},function(){d.cancel(n),n=void 0,f.path("/auth")})),i()}).error(j)}function i(){k(),l(!1),angular.isDefined(n)||(n=d(function(){l(!0)},1e4))}function j(b){a.message="Ett fel uppstod, felmeddelande: "+b.message,$("#messageDialog").modal()}function k(){m().then(function(d){b.get(c.apiUrl+"/GetCurrentTemperature/",{headers:d}).success(function(b){a.currentTemperature=b.temperature})})}function l(d){m().then(function(e){b.get(c.apiUrl+"/GetExecutingState/",{headers:e}).success(function(b){a.isExecuting=b.isExecuting,a.isActive?null!=b.currentStartLevel?(a.currentStartLevel.hour=b.currentStartLevel.hour,a.currentStartLevel.minute=b.currentStartLevel.minute,a.currentStartLevel.second=b.currentStartLevel.second,a.currentStartLevel.temperature=b.currentStartLevel.temperature,$("#hasStartLevelText").show(),$("#noStartLevelText").hide()):($("#hasStartLevelText").hide(),$("#noStartLevelText").show()):($("#hasStartLevelText").hide(),$("#noStartLevelText").hide()),d||(a.hour=b.hour,a.minute=b.minute,a.isActive=b.isActive)})})}function m(){var a=g.defer();return o?e.getUser().then(function(b){a.resolve({Authorization:"Bearer "+b.token.token})},function(){f.path("/auth"),a.reject()}):a.resolve({}),a.promise}var n,o=!1;h(),a.isActive=!0,a.currentTemperature="0.0",a.isExecuting=!1,a.hour="00",a.minute="00",a.currentStartLevel={hour:0,minute:0,second:0,temperature:0},a.goToAuth=function(){d.cancel(n),n=void 0,f.path("/auth")},a.save=function(){m().then(function(d){b.post(c.apiUrl+"/SetSchedule/",{Hour:a.hour,Minute:a.minute,ActiveState:a.isActive},{headers:d}).success(function(){a.message="Tiden är uppdaterad",$("#messageDialog").modal()}).error(j)})},a.controlExecutable=function(a,d){m().then(function(e){b.post(c.apiUrl+"/ControlExecutable/",{SendOnFlags:a,MinutesToKeepRunning:d},{headers:e}).success(function(){l(!0)}).error(j)})}}]),angular.module("temperatureWatcherwebAppApp").controller("AuthCtrl",["$scope","AuthService","$location","$route",function(a,b,c,d){b.getUser().then(function(b){a.username=b.username,a.password1=b.password}),a.cleanCache=function(){b.removeCookie(),d.reload()},a.goBack=function(){c.path("/")},a.save=function(){return a.password1!=a.password2?(a.message="Lösenorden överensstämmer inte",void $("#messageDialog").modal()):void b.updateUser(a.username,a.password1).then(function(){a.message="Uppgifterna lagrade",$("#messageDialog").modal()},function(b){var c=void 0!=b&&void 0!=b.error_description?b.error_description:"Anropet misslyckades";a.message="Kunde inte lagra uppgifter, orsak: "+c,$("#messageDialog").modal()})}}]),angular.module("temperatureWatcherwebAppApp").service("AuthService",["AppSettings","$cookies","$q","$http","$cookieStore",function(a,b,c,d,e){function f(f,h){var i=c.defer();return d.post(a.tokenUrl,{grant_type:"password",username:f,password:h},{headers:{"Content-Type":"application/x-www-form-urlencoded"},transformRequest:function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}}).success(function(a){g={username:f,password:h,token:{token:a.access_token,expires:moment().add(a.expires_in,"seconds").format()}},b.temperatureWatcher=JSON.stringify(g),i.resolve(g)}).error(function(a){e.remove("temperatureWatcher"),i.reject(a)}),i.promise}var g,h=function(){var a=c.defer();if(void 0==g){var d=b.temperatureWatcher;if(void 0!=d)try{g=JSON.parse(d)}catch(h){e.remove("temperatureWatcher"),a.reject()}}return void 0!=g?moment()>=moment(g.token.expires)?f().then(function(){a.resolve(g)},function(b){a.reject(b)}):a.resolve(g):a.reject(g),a.promise},i=function(a,b){return f(a,b)},j=function(){g=null,e.remove("temperatureWatcher")};return{getUser:h,updateUser:i,removeCookie:j}}]);